name: Django CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  # build:

  #   runs-on: ubuntu-latest
  #   strategy:
  #     max-parallel: 4
  #     matrix:
  #       python-version: [3.9]

  #   steps:
  #   - uses: actions/checkout@v3
  #   - name: Set up Python ${{ matrix.python-version }}
  #     uses: actions/setup-python@v3
  #     with:
  #       python-version: ${{ matrix.python-version }}
   
  #   # docker image 빌드
  #   - name: Build docker image
  #     run: docker build -t hwanju1596/kingwangjjang:0.0.1 ./kingwangjjang

  #   # docker hub 로그인
  #   - name: Login docker hub
  #     uses: docker/login-action@master
  #     with:
  #       username: ${{ secrets.DOCKERHUB_USERNAME }}
  #       password: ${{ secrets.DOCKERHUB_TOKEN }}

  #   # docker hub 퍼블리시
  #   - name: Publish to docker hub 
  #     run: docker push hwanju1596/kingwangjjang:0.0.1
  run:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.9]
        
    steps:
    # WAS 인스턴스 접속 & 애플리케이션 실행
    - name: Connect to WAS & Execute Application
      env:
        SUDO_PASSWORD: ${{ secrets.WAS_PASSWORD }}
        ACTIONS_STEP_DEBUG: true
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.WAS_HOST }}
        username: ${{ secrets.WAS_USERNAME }}
        key: ${{secrets.SSH_KEY}}
        port: ${{ secrets.WAS_SSH_PORT }}
        script: |
          ls /usr/local/bin
          echo ${SUDO_PASSWORD} | sudo -S /usr/local/bin/docker version
          whoami

    # Django 데이터베이스 마이그레이션
    - name: Pull Django Project
      env:
        SUDO_PASSWORD: ${{ secrets.WAS_PASSWORD }}
        # ACTIONS_STEP_DEBUG: true
      run: |
        echo ${SUDO_PASSWORD} | sudo -S /usr/local/bin/docker version

    - name: Django DB Mdigration.
      env:
        SUDO_PASSWORD: ${{ secrets.WAS_PASSWORD }}
        # ACTIONS_STEP_DEBUG: true
      run: |
        echo ${SUDO_PASSWORD} | sudo -S /usr/local/bin/docker exec kingwangjjang_migration python manage.py migrate
        echo ${SUDO_PASSWORD} | sudo -S /usr/local/bin/docker stop kingwangjjang_migration
        echo ${SUDO_PASSWORD} | sudo -S /usr/local/bin/docker rm kingwangjjang_migration
